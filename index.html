<html>
    <head>
        <title>Chat</title>
    </head>
    <body>

        <form id="login" onsubmit="register(); return false;">
            <pre> Who are you? </pre>
            <input type="text" id="clientName" />
            <input type="submit" />
        </form>
        
        <table>
            <tr>
            <td>
                <textarea readonly="true" id="textArea" style="resize:none" rows="20" cols="50" wrap="hard">
                </textarea>
            </td>
            <td>
                <ul id="presentUsers">
                    <li onclick="clickUsr(this.innerText)"> click </li>
                </ul>
            </td>
            </tr>
        </table>
        
        <form id="chatbox" onsubmit="sendMessage(); return false;">
            <pre> To: </pre>
            <input type="text" id="recipient" />
            <pre> Message: </pre>
            <input type="text" id="message" />
            <input type="submit" />
        </form>
        
        <script>
            var ws = new WebSocket("ws://127.0.0.1:1234/");
            var clientName = "";
            var textArea = document.getElementById("textArea");
            var presentUsers = document.getElementById("presentUsers");
            var recipient = document.getElementById("recipient");
            var message = document.getElementById("message");

            function register() {
                clientName = document.getElementById("clientName").value;
                ws.send(JSON.stringify({"cmd": "register",
                                        "name": clientName}));
            }

            function sendMessage() {
                if (clientName == "") {
                    alert("Please login");
                    return;
                }
                ws.send(JSON.stringify({"cmd": "send",
                                        "src": clientName,
                                        "dst": recipient.value,
                                        "msg": message.value}));

                var textArea = document.getElementById("textArea");
                textArea.value = textArea.value + "You >> " + recipient.value + ": " + message.value + "\n";
                message.value = "";
            }

            ws.onmessage = function(event) {
                data = JSON.parse(event.data);

                if (data["cmd"] == "recv") {
                    textArea.value = textArea.value + data["src"] + " >> " + data["msg"] + "\n";
                } else if (data["cmd"] == "err") {
                    textArea.value = textArea.value + "Error: " + data["msg"] + "\n";
                } else if (data["cmd"] == "notifusr") {
                    // Do not display client name in list of users
                    data["usrs"].forEach(function(usr) {
                        if (usr != clientName) {
                            var li = document.createElement("li");
                            li.appendChild(document.createTextNode(usr));
                            li.setAttribute("onclick", "clickUsr(this.innerText)");
                            presentUsers.append(li)
                        }
                    });
                }
            };
        
            //handle click on user list
            function clickUsr(destUsr) {
                recipient.value = destUsr;
            };

        </script>
    </body>
</html>
